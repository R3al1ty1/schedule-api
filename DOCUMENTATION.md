# Начало работы

Для начала работы надо склонировать репозиторий

```bash
git clone https://github.com/R3al1ty1/schedule-api.git
```

После этого необходимо переместить в папку src, настроить все секреты (делается один раз) и собрать проект

```bash
cd src
vim .env
docker compose up --build -d
```

Проект собран и работает. Далее необходимо настроить доменное имя, поскольку Telegram Mini Apps не работает в незащищенными источниками.

# Документация

В папке src находится весь код проекта. В самой папке находятся главные файлы, необходимые для сборки проекта, главный .py файл - main.py.

В папке api находятся все эндпоинты (ручки) для взаимодействия с приложением.

В core лежат все файлы для работы приложения, включая файлы с настройками, модели БД и схемы взаимодействия с API.

Папка crud предназначена для хранения всех файлов взаимодействия с БД.

Модуль telegram_bot хранит в себе все файлы для бота.

## Бизнес-логика приложения

Приложение реализует систему бронирования площадки с поддержкой ролей пользователей (администратор и обычный пользователь), возможностью управления бронированиями, комментариями и экспортом расписания.

### Основные сущности и процессы

- **Бронирование**  
  Пользователь может создать заявку на бронирование площадки, указав даты, количество участников, описание мероприятия и другую информацию.  
  При создании бронирования система проверяет:
  - Корректность дат (дата начала не позже даты окончания)
  - Не превышено ли максимальное количество участников
  - Нет ли пересечений с уже существующими бронированиями (учитывается возможность совместного использования площадки, если позволяет вместимость)

- **Администрирование**  
  Администратор может:
  - Просматривать все бронирования
  - Одобрять или отклонять заявки (при одобрении также проверяется отсутствие конфликтов по датам и вместимости)
  - Удалять и редактировать любые бронирования

- **Права доступа**  
  - Обычный пользователь может видеть и управлять только своими бронированиями.
  - Администратор имеет доступ ко всем заявкам и дополнительным функциям.

- **Комментарии**  
  Пользователь или администратор может добавить комментарий к бронированию, если он является владельцем заявки или администратором.

- **Экспорт расписания**  
  Администратор может экспортировать расписание бронирований за определённый период в формате Excel. Файл автоматически отправляется в Telegram.

- **Календарь**  
  Система предоставляет агрегированные данные по бронированиям для отображения занятости площадки в календарном виде.

### Кратко по основным операциям

- Создание бронирования — доступно всем пользователям, с проверкой дат, вместимости и пересечений.
- Просмотр списка бронирований — пользователь видит только свои, администратор — все.
- Одобрение/отклонение — только для администратора, с дополнительной проверкой на конфликты.
- Редактирование/удаление — владелец или администратор.
- Добавление комментариев — владелец или администратор.
- Экспорт расписания — только для администратора, результат отправляется в Telegram.
- Проверка роли пользователя (админ/не админ) — отдельная ручка.

## Техническая документация

### 1. Архитектура проекта

- **src/** — основная папка с исходным кодом.
  - **main.py** — точка входа FastAPI-приложения.
  - **api/** — содержит все роутеры (эндпоинты) для взаимодействия с клиентом:
    - `booking.py` — обработка бронирований (создание, просмотр, изменение, удаление, комментарии).
    - `schedule.py` — экспорт расписания в Excel.
    - `user.py` — проверка прав администратора.
  - **core/** — ядро приложения:
    - `consts.py` — константы (например, максимальная вместимость).
    - `db_helper.py` — вспомогательные функции для работы с БД.
    - `settings.py` — конфигурация приложения.
    - `utils.py` — вспомогательные утилиты (проверка прав, проверка вместимости и т.д.).
    - **models/** — SQLAlchemy-модели для таблиц БД.
    - **schemas/** — Pydantic-схемы для валидации и сериализации данных.
  - **crud/** — функции для работы с БД (CRUD-операции).
  - **telegram_bot/** — интеграция с Telegram-ботом (отправка уведомлений, экспорт файлов и т.д.).

### 2. Запуск и настройка

- Все переменные окружения настраиваются в файле `.env` (см. пример в README).
- Для запуска используется Docker Compose:  
  ```bash
  docker compose up --build -d
  ```
- После запуска приложение доступно на порту, указанном в настройках.

### 3. Работа с БД

- Используется PostgreSQL (см. настройки в docker-compose.yml и .env).

### 4. Основные зависимости

- FastAPI — основной web-фреймворк.
- SQLAlchemy — работа с БД.
- Pydantic — валидация данных.
- Loguru — логирование.
- openpyxl — экспорт расписания в Excel.
- Telegram Bot API — отправка уведомлений и файлов.

### 5. Структура эндпоинтов

- `/bookings` — CRUD для бронирований.
- `/bookings/calendar` — данные для календаря занятости.
- `/bookings/{booking_id}/comments` — добавление комментариев.
- `/bookings/{booking_id}/approve` и `/bookings/{booking_id}/reject` — модерация заявок (только для админа).
- `/export/excel/` — экспорт расписания (только для админа).
- `/users/check-admin` — проверка, является ли пользователь админом.

### 6. Роли и авторизация

- Авторизация реализована через передачу `user_id` в заголовке запроса.
- Проверка прав администратора — через функцию `verify_admin`.

### 7. Добавление новых эндпоинтов

- Для добавления нового функционала создайте файл в папке `api/` и зарегистрируйте роутер в `__init__.py`.
- Для работы с БД добавьте соответствующие функции в `crud/` и схемы в `core/schemas/`.

### 8. Логирование и отладка

- Для логирования используется Loguru.
- Все ошибки и важные события логируются автоматически.

### 9. Интеграция с Telegram

- Для отправки уведомлений и файлов используется модуль `telegram_bot`.
- Все настройки для бота — в `telegram_bot/config/config.py`.
