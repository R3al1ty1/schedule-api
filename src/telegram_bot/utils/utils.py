import os
from dotenv import load_dotenv
from typing import Union
from aiogram.types import BufferedInputFile
from io import BytesIO
from core.db_helper import db_helper
from crud.admin import get_all_admin_user_ids
from telegram_bot.config.config import bot
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from sqlalchemy.ext.asyncio import AsyncSession


load_dotenv()

db = db_helper.session_getter


async def send_excel_file(
    user_id: int,
    file: Union[BytesIO, bytes],
    filename: str
) -> None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Excel —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram.

    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        file: –§–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ BytesIO –∏–ª–∏ bytes
        filename: –ò–º—è —Ñ–∞–π–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .xlsx
    """
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥–∞–Ω –∫–∞–∫ bytes, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ –≤ BytesIO
    if isinstance(file, bytes):
        file_obj = BytesIO(file)
    else:
        file_obj = file
    
    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
    file_obj.seek(0)
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º BytesIO –≤ BufferedInputFile
    input_file = BufferedInputFile(
        file_obj.getvalue(),
        filename=filename
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await bot.send_document(
        chat_id=user_id,
        document=input_file,
        caption="–í–∞—à —Ñ–∞–π–ª —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º üìä"
    )

async def new_booking_notification(
    booking_details: str,
    status: str = "approved",
    db: AsyncSession = None
) -> None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–æ–π –Ω–∞ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    """
    keyboard = InlineKeyboardMarkup(
            inline_keyboard=[[
                InlineKeyboardButton(
                    text="–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏üöÄ",
                    url=f"https://t.me/tavrida_schedule_bot/tavrida_schedule"
                )
            ]]
        )

    if status != "pending":
        if status == "approved":
            message = (
                "‚úÖ <b>–û–¥–æ–±—Ä–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!</b>\n\n"
                f"<b>–î–µ—Ç–∞–ª–∏:</b>\n{booking_details}"
            )

        elif status == "rejected":
            message = (
                "‚ùå <b>–ó–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!</b>\n\n"
                f"<b>–î–µ—Ç–∞–ª–∏:</b>\n{booking_details}"
            )
        elif status == "changed":
            message = (
                "‚úèÔ∏è <b>–ó–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∞!</b>\n\n"
                f"<b>–î–µ—Ç–∞–ª–∏:</b>\n{booking_details}"
            )

        await bot.send_message(
            chat_id=os.getenv("NOTIFICATIONS_CHAT_ID"),
            text=message,
            parse_mode="HTML",
            reply_markup=keyboard
        )

    else:
        message = (
            "üîî <b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!</b>\n\n"
            f"<b>–î–µ—Ç–∞–ª–∏:</b>\n{booking_details}"
        )
        
        chat_ids = await get_all_admin_user_ids(db=db)

        for chat_id in chat_ids:
            await bot.send_message(
                chat_id=chat_id,
                text=message,
                parse_mode="HTML",
                reply_markup=keyboard
            )
